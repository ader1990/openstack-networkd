# openstack-networkd
Agent for enforcing OpenStack network  changes on the VMs.

Currently supports Ubuntu with systemd installed. Windows support will be added shortly.

The agent is supposed to run as a service and poll for OpenStack network metadata.

Info:
  * Polls for http://169.254.169.254/openstack/latest/network_data.json
  * Poll interval is 5 seconds.
  * Uses jq to safely compare network metadata in json format, as the metadata has keys in different order for different requests.
  * When a change is detected, cleans up previous cloud-init runs and executes "cloud-init init"
  * Retries max 10 times if cloud-init status is not successful
  * Applies netplan config generated by cloud-init and restarts network-service for older versions
  * Logs to serial console ttyS0 important information (success/error)

# Dependencies for Linux:

  * curl
  * jq (is used to compare network metadata in json format)
  * systemd
  * cloud-init

# Userdata example for Ubuntu 18.04

```bash
#!/bin/bash

set -e

apt update

# Ubuntu does not have jq by default
apt install -y jq

git clone https://github.com/ader1990/openstack-networkd
bash openstack-networkd/scripts/install_service.sh

```

# Other implementations

## The simpler

Just change the IP of the port, the service will take care of the change seamlessly:

```bash
openstack port set --no-fixed-ip \
    --fixed-ip subnet=12e82270-8b8d-4bd9-9e2d-2cad7627ab3f,ip-address=192.168.5.25 9378d72b-9295-41cd-a379-54fe4c0b8784
```

## The ugly

This can be done with udev rules as the trigger versus the polling.

The problem with udev is that the rules can be triggered at boot time or anytime the kernel feels like it,
so we still need the verification of the old versus new metadata and to be sure that it is only one instance of whatever
triggers the network update.

The udev rules would look like this:

```bash
# file /etc/udev/rules.d/70-persistent-net.rules

ACTION=="add", SUBSYSTEMS=="net", RUN+="/root/openstack-networkd/src/openstack-networkd.sh"
ACTION=="remove", SUBSYSTEMS=="net", RUN+="/root/openstack-networkd/src/openstack-networkd.sh"

udevadm control --reload-rules

```

